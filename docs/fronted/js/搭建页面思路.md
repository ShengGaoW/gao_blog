# 蓝鲸一体化运营平台技术方案总结

<a name="v5giit"></a>

# [](#v5giit)项目背景

蓝鲸一体化运营平台，主要致力于解决原有平台搭建配置复杂、不连续，配置成本高，数据分析困难等问题。我们的目标是统一流程、配置方式，降低运营配置成本，让运营把重心放到如何设计策划活动模型，通过数据反馈，不断的改进活动模型的方案，使得营销全生命周期能够配置化，数据化，智能化。

<a name="0u0eyb"></a>

## [](#0u0eyb)核心业务流程

一个完整的业务流程需要通过：活动策划、页面设计、模块开发、页面搭建、页面投放、数据监控、数据分析等，多个阶段来实施活动推广、数据统计、策略复盘，再不断优化策略，用户偏好，内容，从而提高运营活动的转化率。<br />![](https://cdn.nlark.com/lark/0/2018/png/114273/1539527770805-5a31bc80-b882-497e-80cb-62a77a72bc3d.png#width=827)

<a name="g4nxcu"></a>

## [](#g4nxcu)搭建业务流程

![](https://cdn.nlark.com/lark/0/2018/png/114273/1539527664871-868af346-befe-4759-ad57-2e7711bfbbe8.png#width=827)<br />如上图所示，蓝鲸平台为运营提供了一站式服务平台：

* 物料准备：蓝鲸集成了各平台的数据接口，在蓝鲸可以直接搜索到相关物料名称，选中到模块配置中即可。

* 页面搭建：蓝鲸提供了模块管理、页面管理、模板管理、项目管理、策略管理、预览、图片上传等服务。

* 数据定投：蓝鲸平台所有模块都支持：按照人群、终端、渠道、时段的维度进行数据定投，不再需要人工干预手动切换。

* 页面投放：现有平台已经支持H5、Rax、PC、TV多端页面搭建、并能够通过页面数据，自动化生成埋点投放链接。

<a name="mbd7ne"></a>

# [](#mbd7ne)平台架构设计

<a name="4mzxtm"></a>

## [](#4mzxtm)平台简介

随着业务的发展，蓝鲸平台以解决多平台、多终端、多业务场景，所带来的前端开发成本不可控的问题，为目标的核心价值。提出代码复用、解决方案复用、业务复用的方案，来减少业务带来的研发成本，将重复的工作交给平台和机器来解决，将创新性的研发工作与场景，留给研发团队，才能有效的撬动业务需求的杠杆。

![](https://intranetproxy.alipay.com/skylark/lark/0/2019/png/114273/1546425154449-52f4ce94-7278-46a7-92b0-aaeaf996dd45.png#width=573)
<a name="sdnftm"></a>

## [](#sdnftm)平台优势

蓝鲸平台结合了运营的实际业务场景，为运营优化各个方面的搭建体验，大幅提升了运营效率。

* 一站式可视化搭建，打通接入了各底层数据平台；

* 支持多平台的数据源导入；

* 丰富的表单录入组件；

* 模块级的跨页面数据复制；

* 多套配置数据分发，可通过（人群、时间、渠道、终端）划分策略；

<a name="8y3hcx"></a>

## [](#8y3hcx)平台的架构设计

整个平台系统依赖了多个子系统，如：ABS、DE、Air、UPX、DE、VMP、MRP等系统，将原有割裂的业务系统，通过集团内部的RPC服务HSF Service将子系统数据集成打通，从而实现一站式的服务平台。

![](https://intranetproxy.alipay.com/skylark/lark/0/2019/png/114273/1546425174558-957504e3-3de4-45bb-afdc-ce1bed15df39.png#width=659)

<a name="geznpq"></a>

### [](#geznpq)页面搭建

页面搭建时蓝鲸平台中一项重要的基础能力，通过搭建方式产出页面，从设计之初，我们考虑到为了满足各种不同的搭建业务场景，将页面抽象为3个部分： `页面模板(Xtemplate)` 、 `页面构建脚本(PageInit)` 、 `模块脚本(Mod)` ，这三个部分，可以根据需求适应不同页面的渲染诉求，将PC/Phone/TV的搭建业务抽离出来，可以在不同的业务规范，来构建自己的场景需求。<br />![](https://intranetproxy.alipay.com/skylark/lark/0/2019/png/114273/1546425198602-aa12e398-f722-4909-bf24-4a69b84d66ef.png#width=827)

注：图中Solution解决方案中包含了（页面模板Xtemplate、页面脚本PageInit）

<a name="wll0or"></a>

#### [](#wll0or)场景支持

* 支持PC /TV /Phone各终端的页面搭建。

* 支持H5/Rax 两种模式的页面渲染，可根据各自的业务场景，动态扩展逻辑。

<a name="biuwqb"></a>

#### [](#biuwqb)复用性

* 模块复用：模块一次开发后，可以满足运营的常见诉求；

* 数据复用：由于模块会根据不同的数据配置，展现不同的形态，所以模块的数据源，需要多份数据源动态切换，才能减少日常配置的复杂度。

* 模板复用：由于运营分为不同内容、活动组，每个组对于页面的搭建场景，都有各组常用的需求场景，因此，平台可以将有类型特性的页面生成为模板，便于在下次搭建时选择复用。

<a name="gltyvr"></a>

#### [](#gltyvr)扩展性

* 页面主要由：页面模板、页面脚本、模块脚本组成

  + 页面模板：使用Xtemplate结合Air语法规范，描述的页面HTML的渲染结构。

  + 页面脚本：主要用于初始化页面基本信息，并渲染模块视图，加载模块脚本。

  + 模块脚本：主要用于在视图渲染完后，执行模块内部逻辑。

* 可根据不同的业务场景，构建不同的扩展规范，即可满足业务

  + 以React页面搭建为例，只需要构建React的`页面模板`、`页面脚本`、`模块脚本`，即可实现新的业务搭建方案。

<a name="g9k3zi"></a>

#### [](#g9k3zi)开放性

模块只要满足开发规范，与页面的PageInit渲染脚本规范结合，即可完成渲染。

* 通用性强：蓝鲸制定的模块规范，支持跨平台使用，最大程度的支持了模块的复用。

* 多数据源：支持媒资、VMP、SCG、MRP 等多平台数据源导入。

* 无缝迁移：蓝鲸平台支持大部分淘系的模块规范，可直接注册到平台中使用。

* 标准规范：上游平台Gaia可根据Sketch的元素结构，按照平台的模块标准规范，生成模块代码，为设计赋能。

因为搭建业务并不与实际业务耦合，所以平台可以支持各种搭建需求场景，目前已支持业务：商业化平台、优酷活动、内容运营投放，未来会支持更多的业务场景。

<a name="74h7xo"></a>

#### [](#74h7xo)页面的应用场景

用户访问流量主要分为以下类型：

* 移动端Html5

* PC端Html5

* 移动端Weex容器

![](https://intranetproxy.alipay.com/skylark/lark/0/2019/png/114273/1546425231189-b9b41d9a-7387-4c36-83d3-f5fc79beac9a.png#width=485)

<a name="8dk2pa"></a>

### [](#8dk2pa)页面结构

<a name="y3bmka"></a>

#### [](#y3bmka)Xtemplate模板渲染

* 平台采用模块依赖分析的方法，有效的解决了模块的：重复引用、版本依赖问题。

  + 模块打包发布到UPX平台；

  + 生成deps.json文件，来描述模块与组件库之间的依赖关系；

  + 在页面渲染时，分析deps.json将重复引用合并；并合并不同小版本号为最新版本；

  + 将模块的引用依赖的js，组合成CDN地址；

  + 最后由Air平台使用Xtemplate语法渲染页面；

* 页面采用CMD require模块化方案

  + 模块发布时，会生成index.cmd.js的文件；

  + 通过 `g.alicdn.com` 服务，将js内容组合到一个js文件地址中；

  + 在页面中使用 require & define 来关联加载js模块；

<a name="bsgzha"></a>

#### [](#bsgzha)PageInit主要构成

* 初始化页面DOM元素，将模块的容器元素渲染完成；

* 获取模块的分桶定投数据；

* 渲染Module(Xtemplate)模板代码；

* 加载Module(JavaScript)脚本代码；

<a name="q5g7dx"></a>

#### [](#q5g7dx)模块主要构成

* MockData：用于描述模块的初始化**配置数据**，及本地调试模拟数据内容。

* Schema：用于描述**配置数据的结构**，用于在搭建平台渲染表单元素。

* Xtemplate：渲染模块的**视图View层**；

* Javascript：模块渲染完成后，所执行的**JavaScript脚本代码**；

* CSS：模块的**样式信息**；

* deps.json：通过npm依赖关系生成的 **组件库依赖描述**；

<a name="hdrihu"></a>

#### [](#hdrihu)页面构建流程

* 根据运营页面需求，当运营需要的模块场景，是已有模块已经支撑的，运营只需要在平台中选取需要的模块，平配置相关的数据信息，即可完成页面的搭建。

* 当模块需求无法满足运营场景时，需要前端开发同学接入，按照运营的需求去开发模块，来满足运营的页面需求。

![](https://intranetproxy.alipay.com/skylark/lark/0/2019/png/114273/1546425245500-359ec111-389b-47c9-abde-82cee6cdef0d.png#width=827)

<a name="m8rcgi"></a>

## [](#m8rcgi)前端技术方案

<a name="e9o6gi"></a>

### [](#e9o6gi)前端项目基础架构图

![](https://intranetproxy.alipay.com/skylark/lark/0/2019/png/114273/1546522123639-b1a5973d-26c2-4e82-8aed-30c55f0fd5eb.png#width=583)
<a name="vldnii"></a>

### [](#vldnii)React

* React技术框架，相对于Vue学习曲线复杂一些，但React更灵活些且语法相对优雅。

* 同时前端的视图组件库选择Fusion-Design，可与设计师协同控制组件样式，也是基于React框架编写。

* 目前集团平台多数业务级前端框架，也是基于React框架编写，选择React对于集团已积累的技术平台开放性更好。

<a name="oqeinv"></a>

### [](#oqeinv)Redux/React-Redux

主要用于解决复杂页面多视图组件，需要共享同一份数据状态的问题。

* 创建Action，声明type类型，附加payload 或其他数据节点，作为事件源。

* 创建Reducer，用于接收Action事件源，并将数据处理后的结果，写入状态树（Store）。

* 创建Middleware，统一处理Action数据流的中间环节，例如Fetch解析、Log记录等。

<a name="7k7slv"></a>

### [](#7k7slv)ES6

* 本项目以ES6语法提案，为项目的开发标准，使用babel-stage-0编译器，支持ES6 stage-1~4的所有语法提案。

* 具体语法详解，可参看：阮一峰老师的ES6详解 [http://es6.ruanyifeng.com/](http://es6.ruanyifeng.com/)

<a name="9k0uky"></a>

### [](#9k0uky)Fusion-Design

* Fusion框架：通过前端与设计分离的方式，全面提升设计开发效率，解决了设计与开发强耦合的问题。

* 基于Fusion框架，蓝鲸平台又封装迭代了以下组件库：

  + 动态表单渲染：DynamicForm

  + 动态表格组件：DynamicTable

  + 文件上传组件：Uploader

  + 弹窗浮层管理器：EnhanceLayerManager

<a name="wvkgga"></a>

### [](#wvkgga)数据监控

* 使用RetCode 监控window.onerror

* 网络请求组件Fetch，接入了RetCode，监控了接口请求失败情况。

<a name="d1m3zf"></a>

## [](#d1m3zf)Node端技术方案

<a name="2gmtgt"></a>

## [](#2gmtgt)后端技术框架

因为平台主要面向于内部BU使用，Node端选择集团提供的统一技术框架【Begg】。Begg集成了集团内部常用的插件：如HSF、BUC、ACL、Diamond、Oplog、MySQL等常用插件，便于快速构建后端服务项目与部署。

<a name="s65lns"></a>

### [](#s65lns)前端代码模板化

* 通过Diamond管理前端版本号

* ACL多系统菜单/权限共享

<a name="nr2foi"></a>

### [](#nr2foi)日志跟踪

* 通过CustomLogger记录了三个维度的数据日志

![](https://cdn.nlark.com/lark/0/2018/png/114273/1539534486138-03d69d23-e56c-40ff-b78c-d7589e9a478d.png#width=384)

``` 

* hsfLogger：用于记录所有hsf调用时的错误日志；
* reqLogger：用于记录接口内部逻辑处理的未捕获ThrowError错误；
* sqlLogger：用于记录所有数据库读写时的错误日志；

```

* 并将三种日志记录，统一扩展到ctx.extend，对日志统一格式化处理

![](https://cdn.nlark.com/lark/0/2018/png/114273/1539534873756-18c63398-8c83-4dea-9e10-be95265928a8.png#width=507)

<a name="vw7yxc"></a>

## [](#vw7yxc)平台未来的思考与规划

* 可视化数据平台

  + 实时数据平台

  + 内容动态切换

* 用户分层全量数据分析

* 数据报警平台

  + 定义数据指标，定时检查推送报警邮件

* 设计图一键生成搭建页面

* 模块分析识别，智能AI搭建

* 页面跑分系统，性能优化

* 物料图库数据进一步打通完全一站式
