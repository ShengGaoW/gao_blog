# 深入理解 js 事件循环

**引言**

javascript 是一门单线程的语言，在同一个时间只能做完成一件任务，如果有多个任务，就必须排队，前面一个任务完成，再去执行后面的任务。作为浏览器端的脚本语言，javascript 的主要功能是用来和用户交互以及操作 dom。假设 javascript 不是单线程语言，在一个线程里我们给某个 dom 节点增加内容的时候，另一个线程同时正在删除这个 dom 节点的内容，那岂不乱套了。所以从用户的使用角度出发，javascript 被设计成单线程语言。

由于 js 单线程的设计，假设 js 程序的执行都是同步。如果执行一些耗时较长的程序，例如 ajax 请求，在请求开始至请求响应的这段时间内，当前的工作线程一直是空闲状态， ajax 请求后面的 js 代码只能等待请求结束后执行，因此会导致 js 阻塞的问题。

## 一、异步 & 同步

为解决上述类似上述 js 阻塞的问题，js 引入了同步和异步的概念。

### 1、什么是同步？

“同步模式”就是后一个任务等待前一个任务结束，然后再执行，程序的执行顺序和任务的执行顺序是一致的、同步的。

### 2、什么是异步？

“异步”与同步不同，每一个任务有一个或多个回调函数，前一个任务结束后，不是执行后一个任务，而是去执行回调函数。
后一个任务则是不等前一个任务结束就执行，所以程序的执行顺序与任务的排列顺序是不一致的、异步的。

#### 异步任务

异步任务不会直接进入主线程，而是会进入事件队列中去，只有“事件队列”通知主线程，某个异步任务可以执行了，该任务才会进入主线程执行。

## 二、什么是执行栈(stack)、堆(heap)、事件队列(task queue)？

### 1、执行栈

“栈”是一种数据结构，是一种线性表。特点为 LIFO，即先进后出 （last in, first out）。

利用数组的 push 和  可以实现压栈和出栈的操作。

![stack](https://shenggao.oss-cn-beijing.aliyuncs.com/blog/2020/09/stack.png)

在代码运行的过程中，函数的调用会形成一个由若干帧组成的栈。
```js
function foo(b) {
  let a = 10;
  return a + b + 11;
}

function bar(x) {
  let y = 3;
  return foo(x * y);
}

console.log(bar(7))
```
上面代码最终会在控制台打印42,下面梳理一下它的执行顺序。

1. console.log 函数作为第一帧压入栈中。
2. 调用 bar，第二帧被压入栈中。帧中包含着 bar 的变量对象。
3. bar 调用 foo，foo 做一位第三帧被压入栈中，帧中包含着 foo 的变量对象。
4. foo 执行完毕然后返回。被弹出栈。
5. bar 执行完毕然后返回，被弹出栈。
6. log 函数接收到 bar 的返回值。执行完毕后，出栈。此时栈已空。

![](https://shenggao.oss-cn-beijing.aliyuncs.com/blog/2020/09/stackcall.png)

### 2、堆

对象被分配在堆中，堆是一个用来表示一大块（通常是非结构化的）内存区域的计算机术语。

#### 堆和栈的区别

首先，stack 是有结构的，每个区块按照一定次序存放，可以明确知道每个区块的大小；heap 是没有结构的，数据可以任意存放。因此，
stack 的寻址速度要快于 heap。

其次，每个线程分配一个 stack，每个进程分配一个 heap，也就是说，stack 是线程独占的，heap 是线程共用的。

此外，stack 创建的时候，大小是确定的，数据从超过这个大小，就发生 stack overflow 错误，而 heap 的大小是不确定的，
需要的话可以不断增加。

```java

public void Method1()
{
    int i=4;

    int y=2;

    class1 cls1 = new class1();
}

```

上面代码这三个变量和一个对象实例在内存中的存放方式如下。

![](https://shenggao.oss-cn-beijing.aliyuncs.com/blog/2020/09/stackCall.jpg)

从上图可以看到，i、y和cls1都存放在stack，因为它们占用内存空间都是确定的，而且本身也属于局部变量。但是，cls1指向的对象实例存放在heap，因为它的大小不确定。作为一条规则可以记住，所有的对象都存放在heap。

接下来的问题是，当Method1方法运行结束，会发生什么事？

回答是整个stack被清空，i、y和cls1这三个变量消失，因为它们是局部变量，区块一旦运行结束，就没必要再存在了。而heap之中的那个对象实例继续存在，直到系统的垃圾清理机制（garbage collector）将这块内存回收。因此，一般来说，内存泄漏都发生在heap，即某些内存空间不再被使用了，却因为种种原因，没有被系统回收。

### 3、事件队列

队列是一种数据结构，也是一种特殊的线性表。特点为 FIFO，即先进先出（first in, first out）

利用数组的 push 和 pop 可实现入队和出队的操作。

![](https://shenggao.oss-cn-beijing.aliyuncs.com/blog/2020/09/queue.png)

以下为 mdn 对事件队列或者叫消息队列的解释

js 在运行时包含了一个待处理消息的消息队列。每一个消息都关联着一个用以处理这个消息的回调函数。

在事件循环的某个时刻，

### 4、三者关系

## 三、事件队列有何作用？

## 四、宏任务 & 微任务
### 1、什么是宏任务？
### 2、什么是微任务？
### 3、宏任务和微任务的作用？

## 五、总结


